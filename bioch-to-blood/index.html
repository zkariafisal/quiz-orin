<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>اختبار في , BIOch , BLOOD</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    :root{--primary-color:#4834d4;--accent-color:#f0932b;--bg-gradient:linear-gradient(135deg,#686de0,#4834d4);--correct-color:#2ecc71;--wrong-color:#eb4d4b;}
    body{font-family:'Cairo',sans-serif;background:#f0f3f7;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;direction:rtl;padding:10px;}
    .card{background:#fff;padding:22px 16px;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,0.1);width:100%;max-width:760px;text-align:center;border:4px solid #fff;box-sizing:border-box;}
    .teacher-badge{background:var(--accent-color);color:#fff;padding:6px 20px;border-radius:50px;font-weight:900;margin-bottom:12px;display:inline-block;}
    h1{color:var(--primary-color);font-weight:900;font-size:1.15rem;margin:8px 0 14px;}
    .btn-primary{background:var(--bg-gradient);color:#fff;border:none;padding:12px 18px;border-radius:12px;font-size:1.05rem;font-weight:900;cursor:pointer;width:100%;max-width:260px;}
    .btn-secondary{background:#636e72;color:#fff;border:none;padding:10px 14px;border-radius:12px;font-size:1rem;font-weight:900;cursor:pointer;}
    .btn-nav{background:#ffffff;color:#2d3436;border:2px solid #e0e6ed;padding:10px 14px;border-radius:12px;font-size:1rem;font-weight:900;cursor:pointer;flex:1;min-width:140px;}
    .btn-nav:disabled{opacity:.55;cursor:not-allowed;}
    input[type="text"]{width:100%;box-sizing:border-box;padding:12px;border-radius:10px;border:2px solid #ddd;margin-bottom:12px;font-family:'Cairo';text-align:center;}
    .hidden{display:none;}
    .fade-in{animation:fadeIn .35s ease;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .quiz-header{display:flex;gap:10px;margin-bottom:10px;align-items:stretch;}
    .stat-box{background:#f8f9fa;padding:10px;border-radius:12px;flex:1;border:1px solid #eee;}
    .stat-box .value{display:block;font-size:1.2rem;font-weight:900;color:var(--primary-color);margin-top:2px;}
    .top-actions{display:flex;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
    .top-actions .btn-secondary{flex:1;min-width:160px;}
    .nav-actions{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
    .nav-strip{display:flex;gap:8px;overflow-x:auto;padding:10px 8px;border-radius:14px;background:#f8f9fa;border:1px solid #eee;margin-bottom:12px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;}
    .nav-strip::-webkit-scrollbar{height:8px;}
    .nav-strip::-webkit-scrollbar-thumb{background:#dfe6e9;border-radius:10px;}
    .q-chip{min-width:44px;height:38px;border-radius:12px;border:2px solid #e0e6ed;background:#fff;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;user-select:none;transition:.15s;color:#2d3436;flex:0 0 auto;}
    .q-chip.current{border-color:var(--primary-color);box-shadow:0 4px 12px rgba(72,52,212,.15);}
    .q-chip.correct{background:var(--correct-color);border-color:var(--correct-color);color:#fff;}
    .q-chip.wrong{background:var(--wrong-color);border-color:var(--wrong-color);color:#fff;}
    .q-chip.unanswered{background:#fff;}

    /* عرض السؤال LTR */
    .question-text{direction:ltr;text-align:left;unicode-bidi:isolate;font-weight:900;margin:8px 0 18px;font-size:1.06rem;line-height:1.65;}

    .options-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    @media(min-width:520px){.options-grid{grid-template-columns:1fr 1fr;}}
    .option-btn{background:#fff;border:2px solid #e0e6ed;padding:14px 12px;border-radius:12px;font-size:1rem;font-weight:900;cursor:pointer;transition:.18s;color:#2d3436;font-family:'Cairo';outline:none;display:flex;align-items:center;justify-content:space-between;gap:12px;text-align:right;}
    .option-text{direction:ltr;text-align:left;unicode-bidi:isolate;flex:1;}
    .opt-badge{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:900;border:2px solid #e0e6ed;flex:0 0 auto;}
    .option-btn.correct{background-color:var(--correct-color)!important;color:#fff!important;border-color:var(--correct-color)!important;}
    .option-btn.wrong{background-color:var(--wrong-color)!important;color:#fff!important;border-color:var(--wrong-color)!important;}
    .option-btn.correct .opt-badge,.option-btn.wrong .opt-badge{border-color:rgba(255,255,255,.6);}

    #result-screen{direction:rtl !important;text-align:right !important;}
    #answers-report{max-height:420px;overflow-y:auto;text-align:right !important;direction:rtl !important;unicode-bidi:isolate !important;}
    .report-q{direction:ltr;text-align:left;unicode-bidi:isolate;display:block;font-weight:900;margin-bottom:6px;line-height:1.6;}
    .report-meta{direction:rtl;text-align:right;unicode-bidi:isolate;display:block;font-weight:800;color:#2d3436;line-height:1.8;}
    .report-item{padding:12px;border-radius:10px;margin-bottom:8px;border-right:6px solid #ddd;background:#fff;}
    .correct-item{border-right-color:var(--correct-color);background:#f0fff4;}
    .wrong-item{border-right-color:var(--wrong-color);background:#fff5f5;}
  </style>
</head>

<body>
  <div id="quiz-app" style="width: 100%; display:flex; justify-content:center;">
    <div id="start-screen" class="card fade-in">
      <div class="teacher-badge">إعداد Dr. Zakaria Al-Zubaidi</div>
      <h1>اختبار في , BIOch , BLOOD</h1>
      <input type="text" id="student-name" placeholder="أدخل اسمك الكريم هنا..." />
      <button id="start-btn" class="btn-primary">بدء الاختبار</button>
    </div>

    <div id="quiz-screen" class="card hidden fade-in">
      <div class="quiz-header">
        <div class="stat-box"><span>الوقت</span><span id="time" class="value">75:00</span></div>
        <div class="stat-box"><span>السؤال</span><span class="value"><span id="current-q-num">1</span>/<span id="total-q-num">0</span></span></div>
      </div>

      <div class="top-actions">
        <button id="finish-btn" class="btn-secondary">إنهاء الاختبار</button>
      </div>

      <div class="nav-actions">
        <button id="prev-btn" class="btn-nav">السابق</button>
        <button id="next-btn" class="btn-nav">التالي</button>
      </div>

      <div id="nav-strip" class="nav-strip" aria-label="Question navigation"></div>
      <div id="question-container" class="fade-in"></div>

      <div id="confirm-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);align-items:center; justify-content:center; padding:14px; z-index:9999;">
        <div style="width:100%; max-width:520px; background:#fff; border-radius:18px;padding:18px 16px; box-shadow:0 18px 50px rgba(0,0,0,.25); text-align:center;">
          <div style="font-weight:900; font-size:1.15rem; margin-bottom:8px;">تنبيه</div>
          <div id="confirm-text" style="font-weight:800; color:#2d3436; line-height:1.7; margin-bottom:14px;">بقيت لديك أسئلة لم تجب عليها، هل تريد إنهاء الاختبار؟</div>
          <div style="display:flex; gap:10px;">
            <button id="confirm-no" class="btn-nav" style="flex:1;">لا</button>
            <button id="confirm-yes" class="btn-secondary" style="flex:1;">نعم</button>
          </div>
        </div>
      </div>
    </div>

    <div id="result-screen" class="card hidden fade-in">
      <h2 style="color: var(--primary-color); margin: 0 0 8px;">تقرير الأداء</h2>
      <div id="score-display" style="font-size: 1.8rem; font-weight: 900; margin: 10px 0;"></div>
      <div id="percent-display" style="font-size: 1.1rem; font-weight: 900; color:#2d3436; margin-bottom: 10px;"></div>
      <p style="margin: 6px 0;">الطالب: <strong id="report-name"></strong></p>
      <hr />
      <div id="answers-report"></div>
      <button onclick="location.reload()" class="btn-primary" style="background:#636e72; margin-top: 15px;">إعادة الاختبار</button>
    </div>
  </div>

  <script>
    // المجموعة الثانية (مع حذف نسخة واحدة من المكرر فقط)
    const questions = [
      { q: "59) Starch is digested in saliva by which enzyme?", options: ["Amylase","Lipase","Protease","Trypsin"], correct: 0 },
      { q: "60) Which of the following is a polysaccharide?", options: ["Glucose","Glycogen","Glucagon","Fructose"], correct: 1 },
      { q: "61) What is the precursor for serotonin?", options: ["Proline","Alanine","Glutamine","Tryptophan"], correct: 3 },
      { q: "62) How much ATP is produced per glucose molecule (classic teaching)?", options: ["12","24","38","4"], correct: 2 },
      { q: "63) Which process does insulin increase?", options: ["Glycogenolysis","Gluconeogenesis","Glucogenesis","Ketogenesis","Glycogenesis"], correct: 4 },
      { q: "64) Krebs cycle produces primarily?", options: ["ATP (energy equivalents)","DNA","RNA","Urea"], correct: 0 },
      { q: "65) DNA ligase catalyzes ligation of?", options: ["mRNA with tRNA","Two mRNA molecules","Two tRNA molecules","Two DNA strands"], correct: 3 },
      { q: "66) Glucosamine is used for?", options: ["Osteoporosis","Osteomyelitis","Osteoarthritis","Arthritis infection"], correct: 2 },
      { q: "67) Where does the electron transport chain take place?", options: ["Cytoplasm","Golgi apparatus","Outer mitochondrial membrane","Inner mitochondrial membrane"], correct: 3 },
      { q: "68) How many amino acids are used in human proteins?", options: ["20","30","40","10"], correct: 0 },
      { q: "69) Which parameter is monitored with statin-induced rhabdomyolysis?", options: ["Creatine kinase","CrCl","INR","aPTT"], correct: 0 },
      { q: "70) What is the purpose of mitochondria?", options: ["Synthesis of DNA","Synthesis of RNA","Produce ATP","Store calcium only"], correct: 2 },
      { q: "71) Which represents the most complex level of protein structure?", options: ["Primary","Secondary","Tertiary","Quaternary"], correct: 3 },
      { q: "72) Carboxylation of acetyl-CoA to malonyl-CoA requires which vitamin?", options: ["Biotin (B7)","Riboflavin","Pyridoxine","Nicotinamide"], correct: 0 },
      { q: "73) Methionine to cysteine conversion requires which vitamin?", options: ["B2","B3","B5","B6"], correct: 3 },
      { q: "74) Acetyl-CoA and citric acid cycle: which vitamin is used?", options: ["B6","B12","B2","B9"], correct: 2 },
      { q: "75) What is the carrier that accepts acetyl group in Krebs cycle?", options: ["Oxaloacetate","Citric acid","Acetyl-CoA","Pyruvate"], correct: 0 },
      { q: "76) Net ATP produced in glycolysis is?", options: ["1","22","24","2"], correct: 3 },
      { q: "77) What is the function of snRNAs?", options: ["Act as catalyst","Modify mRNA molecules (splicing)","Genetic blueprint for protein","Translate genetic code"], correct: 1 },
      { q: "78) Which pair represents purine bases?", options: ["Adenine & Uracil","Cytosine & Uracil","Adenine & Guanine","Cytosine & Guanine"], correct: 2 },
      { q: "79) Breakdown of glycogen is called?", options: ["Glycolysis","Glycogenesis","Glycogenolysis","Gluconeogenesis"], correct: 2 },
      { q: "80) Which hormone inhibits gluconeogenesis?", options: ["Insulin","Glucagon","Epinephrine","Glucocorticoid"], correct: 0 },
      { q: "81) Which is a non-essential amino acid?", options: ["Lysine","Valine","Cysteine","Isoleucine"], correct: 2 },
      { q: "82) Which inhibits gluconeogenesis?", options: ["Insulin","Glucagon","Epinephrine","Glucocorticoids"], correct: 0 },
      { q: "83) Which carbohydrate produces more energy per gram?", options: ["Glucose","Maltose","Sucrose","All produce the same amount per gram"], correct: 3 },
      { q: "84) Urea cycle produces urea from?", options: ["Sucrose","Glucose","Glycogen","Ammonia (NH3)"], correct: 3 },
      { q: "85) Carboxylation in fatty acid synthesis requires which vitamin?", options: ["Biotin (B7)","Riboflavin","Pyridoxine","Nicotinamide"], correct: 0 },
      { q: "86) Alcohol dehydrogenase accelerates what reaction?", options: ["Reduction of ethanol","Addition of hydrogen to ethanol","Phosphorylation of ethanol","Removal of hydrogen from ethanol"], correct: 3 },
      { q: "87) Which enzyme forms a DNA copy from RNA?", options: ["Reverse transcriptase","DNA polymerase","Helicase","Primase"], correct: 0 },
      { q: "88) What is a serious side effect common among all anticoagulants?", options: ["Hypokalemia","Major bleeding","Liver dysfunction","Renal dysfunction"], correct: 1 },
      { q: "89) Which is a parenteral direct thrombin inhibitor?", options: ["Enoxaparin","Argatroban","Fondaparinux","Unfractionated heparin"], correct: 1 },
      { q: "90) Which antiplatelet is contraindicated in TIA/stroke?", options: ["Prasugrel","Ticagrelor","Clopidogrel","Dipyridamole"], correct: 0 },
      { q: "91) Which antiplatelet has higher risk of dyspnea?", options: ["Prasugrel","Ticagrelor","Clopidogrel","Dipyridamole"], correct: 1 },
      { q: "92) AF with CHA2DS2-VASc score of 5: recommended?", options: ["Aspirin","Dabigatran","Clopidogrel","No anticoagulation"], correct: 1 },
      { q: "93) Which could decrease INR in patient on warfarin?", options: ["Decreased dietary vitamin K","Carbamazepine therapy","Cotrimoxazole therapy","Metronidazole therapy"], correct: 1 },
      { q: "94) Preferred anticoagulant during hemodialysis?", options: ["Enoxaparin","Dabigatran","Rivaroxaban","Unfractionated heparin (UFH)"], correct: 3 },
      { q: "95) PE bridging warfarin (80 kg, normal CrCl): enoxaparin dose?", options: ["30 mg SC every 24h","40 mg SC every 24h","80 mg SC every 12h","160 mg SC every 12h"], correct: 2 },
      { q: "96) Which medication is an anticoagulant?", options: ["Aspirin","Warfarin","Clopidogrel","Streptokinase"], correct: 1 },
      { q: "97) Mechanism of apixaban?", options: ["Indirect thrombin inhibitor","Indirect factor Xa inhibitor","Direct thrombin inhibitor","Direct factor Xa inhibitor"], correct: 3 },
      { q: "98) Which can decrease the effect of warfarin?", options: ["Antibiotics","Paracetamol","Multivitamins (contain vitamin K)","Calcium supplement"], correct: 2 },
      { q: "99) Dipyridamole best activity?", options: ["Fibrinolytic activity","Antifibrinolytic activity","Platelet aggregation inhibitor","PDE inducer"], correct: 2 },
      { q: "100) Route of enoxaparin?", options: ["Intrathecal bolus","Transdermal injection","Subcutaneous injection","Intramuscular injection"], correct: 2 },
      { q: "101) Which drug lyses fibrin clots?", options: ["Heparin","Warfarin","Enoxaparin","Streptokinase"], correct: 3 },
      { q: "102) Which can decrease the effect of warfarin?", options: ["Antibiotics","Paracetamol","Multivitamins (contain vitamin K)","Calcium supplement"], correct: 2 },
      { q: "103) Antiplatelet effect by inhibiting ADP receptors?", options: ["Aspirin","Abciximab","Clopidogrel","Streptokinase"], correct: 2 },
      { q: "104) Air bubble in enoxaparin syringe: recommended?", options: ["Inject dose with air bubble","Inject air bubble if small","Remove bubble to avoid wastage","Remove bubble and adjust volume"], correct: 0 },
      { q: "105) Serious side effect common among all anticoagulants?", options: ["Hypokalemia","Major bleeding","Liver dysfunction","Renal dysfunction"], correct: 1 },
      { q: "106) UFH is best described as?", options: ["Enolic acid derivative","Propionic acid derivative","Acetyl ester of salicylic acid","Mucopolysaccharide polymers"], correct: 3 },
      { q: "107) Air bubble in enoxaparin syringe: recommended?", options: ["Inject dose with air bubble","Inject air bubble if small","Remove bubble to avoid wastage","Remove bubble and adjust volume"], correct: 0 },
      { q: "108) Risk factor for DVT?", options: ["Age","Food rich in vitamin K","Surgery","All"], correct: 2 },
      { q: "109) Postpartum high-risk DVT prophylaxis duration?", options: ["3 weeks","6 weeks","3 months","6 months"], correct: 1 },
      { q: "110) Parenteral direct thrombin inhibitor?", options: ["Argatroban","Dabigatran","Heparin","Warfarin"], correct: 0 },
      { q: "111) Antiplatelet by inhibition of ADP receptor?", options: ["Aspirin","Abciximab","Clopidogrel","Streptokinase"], correct: 2 },
      { q: "112) DOAC requires initial parenteral anticoagulation 5–10 days before for DVT/PE?", options: ["Apixaban","Rivaroxaban","Edoxaban","Betrixaban"], correct: 2 },
      { q: "113) How does ibuprofen inhibit antiplatelet effect of aspirin?", options: ["Irreversibly acetylates COX-1 before aspirin","Binds reversibly to COX-1 and blocks aspirin access","Increases TXA2","Activates ADP receptors"], correct: 1 },
      { q: "114) Mechanical valve on warfarin INR 3.5. What do you do?", options: ["No management","Decrease warfarin dose","Increase warfarin dose","Stop warfarin and give vitamin K"], correct: 0 },
      { q: "115) Neonate with coagulopathy: which vitamin K route?", options: ["Suppository","IV","SC","IM"], correct: 1 },
      { q: "116) Antiplatelet contraindicated in TIA?", options: ["Dipyridamole","Clopidogrel","Prasugrel","Ticagrelor"], correct: 2 },
      { q: "117) INR monitoring after warfarin initiation outpatient should be after?", options: ["Next day","2–5 days","1 month","3 months"], correct: 1 },
      { q: "118) Treatment option for PE?", options: ["Enoxaparin 40 mg SC once daily","Rivaroxaban","Enoxaparin 1 mg/kg twice daily OR 2 mg/kg once daily","Aspirin"], correct: 2 },
      { q: "119) Warfarin 4.5 mg daily, INR 5.1, no bleeding. Management?", options: ["Hold warfarin + vitamin K IV","Hold warfarin and resume lower dose","Hold warfarin and give platelets","Continue same dose"], correct: 1 },
      { q: "120) In pregnancy, warfarin use is?", options: ["Allowed first trimester","Allowed second trimester","Allowed third trimester","Avoided in pregnancy"], correct: 3 },
      { q: "121) Warfarin 10 mg and INR is low. Why?", options: ["Low dose","Diet","Low bioavailability","Renal failure"], correct: 1 },
      { q: "122) Used in prophylaxis of stroke?", options: ["Anticoagulant","Thrombolytic drug","Antiplatelet","None"], correct: 2 },
      { q: "123) Drug that can induce HIT?", options: ["UFH (unfractionated heparin)","LMWH","Warfarin","Aspirin"], correct: 0 },
      { q: "124) Drug used to treat HIT management?", options: ["UFH","LMWH","Warfarin","Argatroban"], correct: 3 }
    ];

    // ====== State ======
    let currentIdx = 0;
    let score = 0;
    let timeLeft = 75 * 60;
    let studentName = "";
    let timer = null;

    const status = Array(questions.length).fill(null);
    const userChoiceIndex = Array(questions.length).fill(null);
    const letters = ["A","B","C","D","E","F"];

    // ✅ إزالة رقم البداية (مثل 59) ) من نص السؤال عند العرض فقط
    function stripLeadingNumber(text){
      return String(text).replace(/^\s*\d+\s*\)\s*/, "");
    }

    // ====== Helpers ======
    function countUnanswered(){ return status.filter(s => s === null).length; }
    function findFirstUnansweredIndex(){ return status.findIndex(s => s === null); }

    function openConfirmModal(){
      const overlay = document.getElementById("confirm-overlay");
      const text = document.getElementById("confirm-text");
      const unanswered = countUnanswered();
      text.innerText = `بقيت لديك ${unanswered} أسئلة لم تجب عليها، هل تريد إنهاء الاختبار؟`;
      overlay.style.display = "flex";
    }
    function closeConfirmModal(){ document.getElementById("confirm-overlay").style.display = "none"; }

    document.getElementById("confirm-yes").onclick = () => { closeConfirmModal(); end(false); };
    document.getElementById("confirm-no").onclick  = () => {
      closeConfirmModal();
      const idx = findFirstUnansweredIndex();
      if (idx !== -1){ currentIdx = idx; showQ(currentIdx); }
    };

    document.getElementById("total-q-num").innerText = questions.length;

    // ====== Start / Nav ======
    document.getElementById('start-btn').onclick = () => {
      studentName = document.getElementById('student-name').value;
      if(!studentName.trim()) return alert("ادخل اسمك");

      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('quiz-screen').classList.remove('hidden');

      buildNavStrip();
      startTimer();
      showQ(currentIdx);
    };

    document.getElementById("finish-btn").onclick = () => {
      if (countUnanswered() > 0) openConfirmModal();
      else end(false);
    };

    document.getElementById("prev-btn").onclick = () => { if (currentIdx > 0){ currentIdx--; showQ(currentIdx); } };
    document.getElementById("next-btn").onclick = () => { if (currentIdx < questions.length - 1){ currentIdx++; showQ(currentIdx); } };

    function setNavButtons(){
      document.getElementById("prev-btn").disabled = (currentIdx === 0);
      document.getElementById("next-btn").disabled = (currentIdx === questions.length - 1);
    }

    // ====== Timer ======
    function formatTime(totalSeconds){
      const m = Math.floor(totalSeconds/60);
      const s = totalSeconds%60;
      return `${m}:${s<10?'0':''}${s}`;
    }
    function startTimer(){
      document.getElementById('time').innerText = formatTime(timeLeft);
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById('time').innerText = formatTime(timeLeft);
        if(timeLeft <= 0) end(false);
      }, 1000);
    }

    // ====== Nav strip (✅ يبدأ من 1) ======
    function buildNavStrip(){
      const nav = document.getElementById("nav-strip");
      nav.innerHTML = questions.map((q, i) => `<div class="q-chip unanswered" id="chip-${i}" onclick="goTo(${i})">${i+1}</div>`).join("");
      updateNavStrip();
    }
    function updateNavStrip(){
      for(let i=0;i<questions.length;i++){
        const chip = document.getElementById(`chip-${i}`);
        chip.classList.remove("current","unanswered","correct","wrong");
        if (i === currentIdx) chip.classList.add("current");
        if (status[i] === null) chip.classList.add("unanswered");
        else if (status[i] === true) chip.classList.add("correct");
        else chip.classList.add("wrong");
      }
      const currentChip = document.getElementById(`chip-${currentIdx}`);
      if (currentChip) currentChip.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
    }
    window.goTo = (idx) => { currentIdx = idx; showQ(currentIdx); };

    // ====== Render (✅ عرض رقم جديد يبدأ من 1) ======
    function showQ(idx){
      const q = questions[idx];
      document.getElementById('current-q-num').innerText = idx + 1;

      const alreadyAnswered = (status[idx] !== null);
      const cleanQ = stripLeadingNumber(q.q);

      const optionsHtml = q.options.map((o, i) => {
        const letter = letters[i] || String(i+1);
        return `
          <button class="option-btn" onclick="check(this, ${idx}, ${i})">
            <span class="option-text">${o}</span>
            <span class="opt-badge">${letter}</span>
          </button>
        `;
      }).join("");

      document.getElementById('question-container').innerHTML = `
        <div class="question-text">${idx+1}) ${cleanQ}</div>
        <div class="options-grid" id="options-parent">${optionsHtml}</div>
      `;

      if (alreadyAnswered){
        const parent = document.getElementById("options-parent");
        const btns = parent.querySelectorAll(".option-btn");
        btns.forEach(b => b.style.pointerEvents = "none");

        const userIdx = userChoiceIndex[idx];
        const correctIdx = q.correct;
        if (userIdx !== null && btns[userIdx]) btns[userIdx].classList.add(status[idx] ? "correct" : "wrong");
        if (btns[correctIdx]) btns[correctIdx].classList.add("correct");
      }

      updateNavStrip();
      setNavButtons();
    }

    window.check = (btn, qIdx, optIdx) => {
      if (status[qIdx] !== null) return;

      const q = questions[qIdx];
      const isCorrect = (optIdx === q.correct);

      userChoiceIndex[qIdx] = optIdx;
      status[qIdx] = isCorrect;

      if (isCorrect){ btn.classList.add("correct"); score++; }
      else {
        btn.classList.add("wrong");
        const buttons = document.querySelectorAll('#options-parent .option-btn');
        if (buttons[q.correct]) buttons[q.correct].classList.add("correct");
      }

      document.getElementById('options-parent').style.pointerEvents = 'none';
      updateNavStrip();

      setTimeout(() => {
        if (currentIdx < questions.length - 1){ currentIdx++; showQ(currentIdx); }
        else { if (countUnanswered() > 0) openConfirmModal(); else end(false); }
      }, 500);
    };

    // ====== Report (✅ التقرير يبدأ من 1) ======
    function end(isEarly){
      clearInterval(timer);

      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');

      document.getElementById('report-name').innerText = studentName;

      const total = questions.length;
      const answeredCount = status.filter(s => s !== null).length;
      const correctCount = status.filter(s => s === true).length;
      const percent = total === 0 ? 0 : Math.round((correctCount / total) * 100);

      document.getElementById('score-display').innerText = `${correctCount} / ${total}`;
      document.getElementById('percent-display').innerText =
        isEarly ? `تم إنهاء الاختبار مبكرًا: أُجيب على ${answeredCount} سؤال — النسبة: ${percent}%`
                : `النسبة: ${percent}%`;

      const reportIdxs = [...Array(total).keys()];
      document.getElementById('answers-report').innerHTML = reportIdxs.map((i) => {
        const q = questions[i];
        const userIdx = userChoiceIndex[i];
        const correctIdx = q.correct;
        const isCorrect = status[i] === true;

        const userTxt = (userIdx === null) ? "لم يتم الإجابة" : `${letters[userIdx]}: ${q.options[userIdx]}`;
        const corrTxt = `${letters[correctIdx]}: ${q.options[correctIdx]}`;

        return `
          <div class="report-item ${isCorrect ? 'correct-item' : 'wrong-item'}">
            <span class="report-q">${i+1}) ${stripLeadingNumber(q.q)}</span>
            <span class="report-meta">إجابتك: ${userTxt} | الصح: ${corrTxt}</span>
          </div>
        `;
      }).join('');
    }
  </script>
</body>
  </html>
